---
inclusion: always
---

# タスク実行ガイドライン

## タスク実行の基本原則

### 順次実行

- **1つずつ実行**: 一度に1つのタスクのみを実行する
- **完了確認**: タスクが完全に完了してから次のタスクに進む
- **依存関係の尊重**: 前のタスクに依存するタスクは、依存タスクの完了後にのみ実行する

### タスク完了の定義

タスクが完了したと見なされるのは、以下の全ての条件を満たした場合のみ：

1. ✅ **コードの実装**: タスクで要求された全てのコードが実装されている
2. ✅ **テストの実行**: `make test` が成功している（全ての単体テストが通過）
3. ✅ **型チェック**: TypeScriptの型エラーがない
4. ✅ **リント**: ESLintエラーがない
5. ✅ **手動確認**: タスクに記載された手動確認事項が全て完了している
6. ✅ **ビルド**: `npm run build` が成功している（該当する場合）

## タスク実行フロー

### ステップ1: タスクの開始

```bash
# タスクステータスを「進行中」に更新
# Kiro IDEの「Start task」ボタンをクリック
```

### ステップ2: コードの実装

- タスクの説明に従ってコードを実装
- ファイルサイズを500行以内に保つ
- 必要に応じてファイルを分割

### ステップ3: テストの作成（オプションタスクでない場合）

- タスクに対応する単体テストを作成
- テストファイルは実装ファイルと同じディレクトリに配置
- `.test.ts` または `.spec.ts` の拡張子を使用

### ステップ4: テストの実行

```bash
# 全てのテストを実行
make test

# または
npm test
```

**重要**: テストが失敗した場合、次のタスクに進んではいけません。失敗を修正してから進みます。

### ステップ5: 型チェックとリント

```bash
# 型チェック
npx tsc --noEmit

# リント
npm run lint
```

### ステップ6: ビルドの確認

```bash
# ビルド
npm run build
```

ビルドエラーがある場合は修正します。

### ステップ7: 手動確認

タスクに記載された手動確認事項を実行：

- ブラウザでの動作確認
- UI要素の表示確認
- 機能の動作確認
- エッジケースのテスト

### ステップ8: タスクの完了

全ての確認事項が完了したら：

```bash
# タスクステータスを「完了」に更新
# Kiro IDEの「Mark as complete」ボタンをクリック
```

## タスクリストの確認事項

### 各タスクに含めるべき情報

1. **実装内容**: 何を実装するか
2. **ファイルパス**: どのファイルを作成・編集するか
3. **要件参照**: どの要件に対応するか
4. **手動確認事項**: 実装後に手動で確認すべき項目（該当する場合）

### 手動確認事項の例

```markdown
- [ ] 1. プレイヤー移動の実装
  - src/client/player/player-controller.tsを作成
  - WASD キーでの移動を実装
  - _要件: 3.1, 3.2, 3.3, 3.4_
  - **手動確認**:
    - [ ] ブラウザで `npm run dev` を実行
    - [ ] W キーで前進することを確認
    - [ ] A キーで左移動することを確認
    - [ ] S キーで後退することを確認
    - [ ] D キーで右移動することを確認
    - [ ] 移動がスムーズであることを確認
```

## テスト実行の必須化

### make test の実行

**全てのタスク完了後、次のタスクに進む前に必ず `make test` を実行する**

```bash
make test
```

このコマンドは：
1. 全ての単体テストを実行
2. テストが失敗した場合、非ゼロの終了コードを返す
3. テストが成功した場合のみ、次のタスクに進むことができる

### テスト失敗時の対応

テストが失敗した場合：

1. **エラーメッセージを確認**: どのテストが失敗したかを特定
2. **原因を調査**: 実装のバグかテストのバグかを判断
3. **修正**: バグを修正
4. **再テスト**: `make test` を再実行
5. **成功確認**: 全てのテストが通過するまで繰り返す

### テストのスキップ禁止

- **絶対にテストをスキップしない**: テストが失敗している状態で次のタスクに進まない
- **テストの無効化禁止**: 失敗するテストをコメントアウトしたり削除したりしない
- **品質の維持**: テストは品質保証の要であり、スキップすると後で大きな問題になる

## サブタスクの処理

### 親タスクとサブタスク

親タスクにサブタスクがある場合：

1. **サブタスクから開始**: 親タスクを開始する前に、全てのサブタスクを完了させる
2. **順次実行**: サブタスクを1つずつ順番に実行
3. **各サブタスクで確認**: 各サブタスクごとに `make test` を実行
4. **親タスクの完了**: 全てのサブタスクが完了したら、親タスクを完了とマーク

### オプションタスクの扱い

`*` マークが付いたオプションタスク：

- **実装不要**: オプションタスクは実装しない（MVPに集中）
- **完了マーク不要**: オプションタスクは完了としてマークしない
- **スキップ**: オプションタスクは単純にスキップして次のタスクに進む

## エラーハンドリング

### ビルドエラー

```bash
npm run build
```

ビルドエラーが発生した場合：
1. エラーメッセージを読む
2. 該当ファイルを修正
3. 再ビルド
4. 成功するまで繰り返す

### 型エラー

```bash
npx tsc --noEmit
```

型エラーが発生した場合：
1. エラーの場所を特定
2. 型定義を修正
3. 再チェック
4. エラーがなくなるまで繰り返す

### リントエラー

```bash
npm run lint
```

リントエラーが発生した場合：
1. 自動修正を試す: `npm run lint -- --fix`
2. 手動で修正が必要な場合は修正
3. 再チェック

## ベストプラクティス

### 小さなコミット

各タスク完了後にコミット：

```bash
git add .
git commit -m "feat: implement player movement (task 7.2)"
```

### 定期的なテスト

コードを書きながら定期的にテストを実行：

```bash
# 特定のテストファイルのみ実行
npm test -- path/to/test.ts

# ウォッチモードで実行（開発中）
npm test -- --watch
```

### ドキュメントの更新

必要に応じてコメントやドキュメントを更新：
- 複雑なロジックにはコメントを追加
- 公開APIにはJSDocを追加
- READMEを最新の状態に保つ

## チェックリスト

各タスク完了時に以下を確認：

- [ ] コードが実装されている
- [ ] `make test` が成功している
- [ ] `npx tsc --noEmit` が成功している
- [ ] `npm run lint` が成功している
- [ ] `npm run build` が成功している（該当する場合）
- [ ] 手動確認事項が全て完了している
- [ ] コードが500行以内に収まっている
- [ ] 必要に応じてコミットしている

全てにチェックが入ったら、次のタスクに進むことができます。

## 禁止事項

❌ **やってはいけないこと**:

1. テストが失敗している状態で次のタスクに進む
2. 複数のタスクを同時に実行する
3. タスクの順序を無視する
4. 手動確認をスキップする
5. ビルドエラーを無視する
6. 型エラーを無視する
7. リントエラーを無視する
8. オプションでないテストタスクをスキップする
9. 500行を超えるファイルを作成する
10. 依存タスクが完了していないのに次のタスクを開始する

## まとめ

タスク実行の鉄則：

1. **1つずつ**: 一度に1つのタスクのみ
2. **テスト必須**: `make test` は必ず実行
3. **全て成功**: 全ての確認事項が成功してから次へ
4. **手動確認**: 記載された手動確認を実施
5. **品質維持**: テストをスキップしない

この原則を守ることで、高品質なコードを維持しながら、着実に実装を進めることができます。

# 要件ドキュメント

## はじめに

JetOniは、Reddit上で動作する3Dマルチプレイヤー鬼ごっこゲームです。プレイヤーは都市環境を自由に移動し、鬼から逃げるか、鬼として他のプレイヤーを追いかけます。ジェットパックとダッシュ能力を使用して、建物の屋上や空中を移動できます。

## 用語集

- **システム**: JetOniゲームアプリケーション全体
- **プレイヤー**: ゲームに参加するユーザーまたはAI
- **鬼（ONI）**: 他のプレイヤーをタッチして鬼にする役割のプレイヤー
- **逃げる側（RUNNER）**: 鬼から逃げる役割のプレイヤー
- **ジェットパック**: 空中を飛行するための能力
- **ダッシュ**: 高速移動する能力
- **燃料**: ジェットパックとダッシュを使用するためのリソース
- **ビーコン**: 鬼が全プレイヤーの位置を一時的に表示する能力
- **ラウンド**: ゲームの1回のプレイセッション
- **ホスト**: ゲームを作成したプレイヤー
- **AI**: コンピューター制御のプレイヤー

## 要件

### 要件1: ゲームロビーとセットアップ

**ユーザーストーリー:** ホストとして、ゲームを作成して設定を選択したい。

#### 受入基準

1. WHEN ユーザーがタイトル画面で「ゲーム作成」ボタンを押す, THEN THE システム SHALL ゲーム設定画面を表示する
2. WHEN ホストがプレイヤー数を選択する, THEN THE システム SHALL 4、6、8、10、15、20人のオプションを提供する
3. WHEN ホストがラウンド時間を選択する, THEN THE システム SHALL 3分または5分のオプションを提供する
4. WHEN ホストがラウンド数を選択する, THEN THE システム SHALL 1、3、5ラウンドのオプションを提供する
5. WHEN ホストが設定を確定する, THEN THE システム SHALL ゲームロビーを作成する

### 要件2: プレイヤー参加とAI補充

**ユーザーストーリー:** プレイヤーとして、既存のゲームに参加したい。

#### 受入基準

1. WHEN ユーザーがタイトル画面で「ゲーム参加」ボタンを押す, THEN THE システム SHALL 利用可能なゲームのリストを表示する
2. WHEN ユーザーがゲームを選択する, THEN THE システム SHALL そのゲームのロビーに参加させる
3. WHEN ゲームが満員でない, THEN THE システム SHALL 新しいプレイヤーの参加を許可する
4. WHEN ゲームが満員である, THEN THE システム SHALL エラーメッセージを表示する
5. WHEN ホストがゲームを開始する, THEN THE システム SHALL 不足しているプレイヤー枠をAIで補充する

### 要件3: プレイヤー移動と操作

**ユーザーストーリー:** プレイヤーとして、都市環境を自由に移動したい。

#### 受入基準

1. WHEN プレイヤーがWASDキーを押す, THEN THE システム SHALL プレイヤーを対応する方向に移動させる
2. WHEN プレイヤーがマウスを動かす, THEN THE システム SHALL カメラの向きを変更する
3. WHEN プレイヤーがスペースキーを押す, THEN THE システム SHALL プレイヤーをジャンプさせる
4. WHEN プレイヤーがShiftキーを押す, THEN THE システム SHALL ダッシュを起動する
5. WHEN プレイヤーがスペースキーを長押しする, THEN THE システム SHALL ジェットパックを起動する
6. WHEN プレイヤーが建物に衝突する, THEN THE システム SHALL プレイヤーの移動を停止する
7. WHEN プレイヤーが水中にいる, THEN THE システム SHALL 移動速度を50%に減少させる

### 要件4: カメラシステム

**ユーザーストーリー:** プレイヤーとして、視点を切り替えたい。

#### 受入基準

1. WHEN プレイヤーがCキーを押す, THEN THE システム SHALL 一人称視点と三人称視点を切り替える
2. WHEN 一人称視点である, THEN THE システム SHALL プレイヤーの目線からの視点を表示する
3. WHEN 三人称視点である, THEN THE システム SHALL プレイヤーの後方5ユニットからの視点を表示する
4. WHEN プレイヤーがマウスを動かす, THEN THE システム SHALL カメラをスムーズに回転させる

### 要件5: 燃料システム

**ユーザーストーリー:** プレイヤーとして、燃料を管理して能力を使用したい。

#### 受入基準

1. WHEN ゲームが開始する, THEN THE システム SHALL 各プレイヤーの燃料を100に設定する
2. WHEN プレイヤーがジェットパックを使用する, THEN THE システム SHALL 毎秒30の燃料を消費する
3. WHEN プレイヤーがダッシュを使用する, THEN THE システム SHALL 毎秒25の燃料を消費する
4. WHEN 鬼が地面にいる, THEN THE システム SHALL 毎秒20の燃料を回復する
5. WHEN 逃げる側が地面で静止している, THEN THE システム SHALL 毎秒20の燃料を回復する
6. WHEN 燃料が0になる, THEN THE システム SHALL ジェットパックとダッシュを無効化する

### 要件6: 鬼の割り当てとタッチ

**ユーザーストーリー:** プレイヤーとして、鬼の役割を理解したい。

#### 受入基準

1. WHEN ラウンドが開始する, THEN THE システム SHALL ランダムに1人のプレイヤーを鬼に割り当てる
2. WHEN 鬼が逃げる側に1.5ユニット以内に接近する, THEN THE システム SHALL その逃げる側を鬼に変更する
3. WHEN プレイヤーが鬼になる, THEN THE システム SHALL そのプレイヤーの移動速度を1.5倍に増加させる
4. WHEN プレイヤーが鬼になる, THEN THE システム SHALL 赤色のマーカーを表示する
5. WHEN プレイヤーが逃げる側である, THEN THE システム SHALL 青色のマーカーを表示する

### 要件7: ビーコンアイテム

**ユーザーストーリー:** 鬼として、ビーコンアイテムを取得して全プレイヤーの位置を確認したい。

#### 受入基準

1. WHEN ラウンドが開始する, THEN THE システム SHALL マップ上にランダムに2つのビーコンアイテムを配置する
2. WHEN ビーコンアイテムが配置される, THEN THE システム SHALL 回転する円形のビジュアルを表示する
3. WHEN 鬼がビーコンアイテムに2ユニット以内に接近する, THEN THE システム SHALL ビーコンアイテムを取得させる
4. WHEN 逃げる側がビーコンアイテムに接近する, THEN THE システム SHALL ビーコンアイテムを取得させない
5. WHEN 鬼がビーコンアイテムを取得する, THEN THE システム SHALL ビーコンを即座に起動する
6. WHEN ビーコンが起動する, THEN THE システム SHALL 10秒間全プレイヤーの位置を表示する
7. WHEN ビーコンが終了する, THEN THE システム SHALL ビーコンアイテムをマップから削除する
8. WHEN ビーコンアイテムが取得される, THEN THE システム SHALL 取得した鬼に通知を表示する

### 要件8: スポット機能

**ユーザーストーリー:** 逃げる側として、鬼が近くにいることを知りたい。

#### 受入基準

1. WHEN 鬼が逃げる側の50ユニット以内にいる, THEN THE システム SHALL 「SPOTTED」インジケーターを表示する
2. WHEN 鬼が50ユニット以上離れる, THEN THE システム SHALL インジケーターを非表示にする
3. WHEN 複数の鬼が範囲内にいる, THEN THE システム SHALL 最も近い鬼に対してインジケーターを表示する

### 要件9: ゲーム終了条件

**ユーザーストーリー:** プレイヤーとして、ゲームの勝敗を知りたい。

#### 受入基準

1. WHEN ラウンド時間が終了する, THEN THE システム SHALL ラウンドを終了する
2. WHEN 全プレイヤーが鬼になる, THEN THE システム SHALL ラウンドを終了する
3. WHEN ラウンドが終了する, THEN THE システム SHALL 各プレイヤーの生存時間を記録する
4. WHEN 全ラウンドが終了する, THEN THE システム SHALL 結果画面を表示する
5. WHEN 結果画面が表示される, THEN THE システム SHALL 最も長く生存したプレイヤーを勝者として表示する

### 要件10: AIプレイヤー

**ユーザーストーリー:** プレイヤーとして、AIと対戦したい。

#### 受入基準

1. WHEN AIが鬼である, THEN THE システム SHALL 最も近い逃げる側を追跡する
2. WHEN AIが逃げる側である, THEN THE システム SHALL 鬼から逃げる
3. WHEN AIの燃料が50%以上である, THEN THE システム SHALL ジェットパックまたはダッシュを使用する
4. WHEN AIが建物に衝突する, THEN THE システム SHALL 別の経路を探す
5. WHEN AIが鬼である, THEN THE システム SHALL ビーコン能力を使用する

### 要件11: UI表示

**ユーザーストーリー:** プレイヤーとして、ゲーム情報を確認したい。

#### 受入基準

1. WHEN ゲームが進行中である, THEN THE システム SHALL 残り時間を表示する
2. WHEN ゲームが進行中である, THEN THE システム SHALL 鬼の数と逃げる側の数を表示する
3. WHEN ゲームが進行中である, THEN THE システム SHALL プレイヤーの燃料ゲージを表示する
4. WHEN プレイヤーが鬼である, THEN THE システム SHALL ビーコンのクールダウンを表示する
5. WHEN 残り時間が60秒以下である, THEN THE システム SHALL タイマーを黄色で表示する
6. WHEN 残り時間が30秒以下である, THEN THE システム SHALL タイマーを赤色で表示する

### 要件12: 環境生成

**ユーザーストーリー:** プレイヤーとして、多様な都市環境でプレイしたい。

#### 受入基準

1. WHEN ゲームが開始する, THEN THE システム SHALL ランダムな都市マップを生成する
2. WHEN マップが生成される, THEN THE システム SHALL 60個の建物を配置する
3. WHEN マップが生成される, THEN THE システム SHALL 40個の家を配置する
4. WHEN マップが生成される, THEN THE システム SHALL 道路をグリッド状に配置する
5. WHEN マップが生成される, THEN THE システム SHALL 川を1本配置する
6. WHEN マップが生成される, THEN THE システム SHALL 川に3つの橋を配置する
7. WHEN マップが生成される, THEN THE システム SHALL ランドマークタワーを1つ配置する

### 要件13: 動的オブジェクト

**ユーザーストーリー:** プレイヤーとして、生き生きとした都市を体験したい。

#### 受入基準

1. WHEN ゲームが進行中である, THEN THE システム SHALL 道路上に車を配置する
2. WHEN 車が配置される, THEN THE システム SHALL 車を道路に沿って移動させる
3. WHEN ゲームが進行中である, THEN THE システム SHALL 歩道に歩行者を配置する
4. WHEN 歩行者が配置される, THEN THE システム SHALL 歩行者を歩道に沿って移動させる
5. WHEN プレイヤーが車または歩行者に衝突する, THEN THE システム SHALL プレイヤーの移動を停止する

### 要件14: モバイル対応

**ユーザーストーリー:** モバイルユーザーとして、タッチ操作でプレイしたい。

#### 受入基準

1. WHEN モバイルデバイスでゲームを開く, THEN THE システム SHALL 仮想ジョイスティックを表示する
2. WHEN ユーザーがジョイスティックをドラッグする, THEN THE システム SHALL プレイヤーを移動させる
3. WHEN モバイルデバイスでゲームを開く, THEN THE システム SHALL ジャンプボタンを表示する
4. WHEN モバイルデバイスでゲームを開く, THEN THE システム SHALL ダッシュボタンを表示する
5. WHEN モバイルデバイスでゲームを開く, THEN THE システム SHALL ジェットパックボタンを表示する

### 要件15: 多言語対応

**ユーザーストーリー:** ユーザーとして、自分の言語でゲームをプレイしたい。

#### 受入基準

1. WHEN ゲームが起動する, THEN THE システム SHALL 英語と日本語をサポートする
2. WHEN ユーザーが言語を選択する, THEN THE システム SHALL 全てのUIテキストを選択した言語で表示する
3. WHEN ユーザーが言語を変更する, THEN THE システム SHALL 選択をlocalStorageに保存する
4. WHEN ゲームが再起動する, THEN THE システム SHALL 保存された言語設定を読み込む

### 要件16: 統計とリーダーボード

**ユーザーストーリー:** プレイヤーとして、自分の成績を確認したい。

#### 受入基準

1. WHEN ゲームが終了する, THEN THE システム SHALL 各プレイヤーの統計をRedisに保存する
2. WHEN プレイヤーが統計画面を開く, THEN THE システム SHALL プレイ回数を表示する
3. WHEN プレイヤーが統計画面を開く, THEN THE システム SHALL 勝利数と敗北数を表示する
4. WHEN プレイヤーが統計画面を開く, THEN THE システム SHALL 合計生存時間を表示する
5. WHEN プレイヤーが統計画面を開く, THEN THE システム SHALL 最長生存時間を表示する

### 要件17: パフォーマンス

**ユーザーストーリー:** プレイヤーとして、スムーズなゲームプレイを体験したい。

#### 受入基準

1. WHEN ゲームが実行される, THEN THE システム SHALL 60FPSを維持する
2. WHEN プレイヤーが20人いる, THEN THE システム SHALL 30FPS以上を維持する
3. WHEN ゲームが読み込まれる, THEN THE システム SHALL 5秒以内に起動する

### 要件18: エラーハンドリング

**ユーザーストーリー:** ユーザーとして、エラーが発生した際に適切な情報を得たい。

#### 受入基準

1. WHEN ネットワークエラーが発生する, THEN THE システム SHALL エラーメッセージを表示する
2. WHEN APIリクエストが失敗する, THEN THE システム SHALL 最大3回リトライする
3. WHEN WebGLが利用できない, THEN THE システム SHALL 互換性エラーメッセージを表示する
4. WHEN ゲームが存在しない, THEN THE システム SHALL 404エラーメッセージを表示する
5. WHEN ゲームが満員である, THEN THE システム SHALL 満員エラーメッセージを表示する

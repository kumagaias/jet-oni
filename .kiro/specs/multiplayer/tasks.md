# マルチプレイヤー機能 実装タスク

- [x] 1. GameAPI Clientの実装

  - [x] 1.1 GameAPIClientクラスを作成
    - src/client/api/game-api-client.tsを作成
    - createGame, joinGame, getGameState, updatePlayerState, endGame, listGamesメソッドを実装
    - エラーハンドリングとリトライロジックを実装
    - _要件: 1.4, 2.2, 2.3, 6.3, 7.1, 7.2_
  - [ ]\* 1.2 GameAPIClientのテストを作成
    - APIメソッドのテスト
    - エラーハンドリングのテスト
    - リトライロジックのテスト
    - _要件: 1.4, 2.2, 2.3_

- [x] 2. GameSyncManagerの実装

  - [x] 2.1 GameSyncManagerクラスを作成
    - src/client/sync/game-sync-manager.tsを作成
    - 送信ループ (100ms間隔)を実装
    - 受信ループ (100ms間隔)を実装
    - 状態補間ロジックを実装
    - _要件: 4.1, 4.3, 4.4, 4.5_
  - [x] 2.2 位置予測と補間を実装
    - 線形補間アルゴリズムを実装
    - 速度ベースの位置予測を実装
    - _要件: 4.4, 8.3_
  - [ ]\* 2.3 GameSyncManagerのテストを作成
    - 同期ループのテスト
    - 補間ロジックのテスト
    - _要件: 4.1, 4.3, 4.4_

- [x] 3. LobbyManagerの実装

  - [x] 3.1 LobbyManagerクラスを作成
    - src/client/lobby/lobby-manager.tsを作成
    - プレイヤーリスト管理を実装
    - リアルタイム更新ロジックを実装
    - _要件: 3.1, 3.2_
  - [x] 3.2 カウントダウン機能を実装
    - 3秒カウントダウンを実装
    - 自動開始ロジックを実装
    - ホストによる早期開始を実装
    - _要件: 3.3, 3.4, 3.5_
  - [ ]\* 3.3 LobbyManagerのテストを作成
    - プレイヤーリスト更新のテスト
    - カウントダウンのテスト
    - _要件: 3.1, 3.2, 3.3_

- [x] 4. UIMenuの更新

  - [x] 4.1 Create Game画面を更新
    - showCreateGameScreenメソッドを更新
    - GameAPIClient.createGameを呼び出す
    - 成功時にロビー画面に遷移
    - エラー時にメッセージを表示
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_
  - [x] 4.2 Join Game画面を更新
    - showJoinGameScreenメソッドを更新
    - GameAPIClient.listGamesを呼び出す
    - ゲームリストを表示
    - ゲーム選択時にGameAPIClient.joinGameを呼び出す
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_
  - [x] 4.3 ロビー画面を更新
    - showLobbyScreenメソッドを更新
    - LobbyManagerを統合
    - プレイヤーリストを表示
    - リアルタイム更新を実装
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_
  - [ ]\* 4.4 UIMenuのテストを更新
    - Create Game画面のテスト
    - Join Game画面のテスト
    - ロビー画面のテスト
    - _要件: 1.1, 2.1, 3.1_

- [x] 5. main.tsの更新

  - [x] 5.1 GameAPIClientを初期化
    - GameAPIClientインスタンスを作成
    - UIMenuに渡す
    - _要件: 1.4_
  - [x] 5.2 GameSyncManagerを統合
    - GameSyncManagerインスタンスを作成
    - ゲーム開始時に同期を開始
    - ゲーム終了時に同期を停止
    - _要件: 4.1, 4.5_
  - [x] 5.3 リモートプレイヤーの表示を実装
    - GameSyncManagerからプレイヤー状態を受信
    - リモートプレイヤーのモデルを更新
    - 補間で滑らかに表示
    - _要件: 4.4, 8.3_
  - [x] 5.4 ゲーム終了処理を更新
    - GameAPIClient.endGameを呼び出す
    - 結果画面に遷移
    - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 6. サーバーAPIの更新

  - [x] 6.1 /api/game/:id/updateエンドポイントを追加
    - POST /api/game/:id/updateを実装
    - プレイヤー状態を受信
    - Redisに保存
    - 状態を検証
    - _要件: 4.1, 4.2, 9.1, 9.2_
  - [x] 6.2 /api/game/listエンドポイントを更新
    - GET /api/game/listを実装
    - Redisから参加可能なゲームを取得
    - ゲームリストを返却
    - _要件: 2.1, 2.2_
  - [x] 6.3 状態検証ロジックを実装
    - 位置の範囲チェック
    - 速度の範囲チェック
    - 異常な値の補正
    - _要件: 9.1, 9.2_
  - [ ]\* 6.4 APIエンドポイントのテストを作成
    - /api/game/:id/updateのテスト
    - /api/game/listのテスト
    - 状態検証のテスト
    - _要件: 4.1, 2.1, 9.1_

- [x] 7. RedisStorageの更新

  - [x] 7.1 updatePlayerメソッドを実装
    - プレイヤー状態をRedisに保存
    - TTLを設定 (1時間)
    - _要件: 4.2, 8.5_
  - [x] 7.2 listGamesメソッドを実装
    - アクティブなゲームIDを取得
    - 各ゲームの状態を取得
    - 参加可能なゲームのみフィルタ
    - _要件: 2.1, 2.2_
  - [x] 7.3 TTL管理を実装
    - ゲーム状態にTTLを設定
    - プレイヤー状態にTTLを設定
    - 期限切れゲームの自動削除
    - _要件: 8.5_
  - [ ]\* 7.4 RedisStorageのテストを作成
    - updatePlayerのテスト
    - listGamesのテスト
    - TTL管理のテスト
    - _要件: 4.2, 2.1, 8.5_

- [x] 8. エラーハンドリングの実装

  - [x] 8.1 ネットワークエラー処理を実装
    - リトライロジック (3回)
    - 指数バックオフ
    - エラーメッセージ表示
    - _要件: 7.1, 7.2_
  - [x] 8.2 サーバーエラー処理を実装
    - エラーコード別の処理
    - 400: バリデーションエラー
    - 404: ゲームが見つからない
    - 500: サーバーエラー
    - _要件: 7.1, 7.3_
  - [x] 8.3 クライアント切断処理を実装
    - タイムアウト検出 (10秒)
    - AIプレイヤーへの置き換え
    - 他のプレイヤーへの通知
    - _要件: 5.5, 7.4_
  - [ ]\* 8.4 エラーハンドリングのテストを作成
    - ネットワークエラーのテスト
    - サーバーエラーのテスト
    - クライアント切断のテスト
    - _要件: 7.1, 7.2, 7.4_

- [-] 9. UI/UXの改善

  - [x] 9.1 ゲームリスト表示を実装
    - ゲーム情報カードを作成
    - プレイヤー数、時間、ラウンドを表示
    - 参加ボタンを実装
    - _要件: 10.1_
  - [x] 9.2 ロビープレイヤーリストを実装
    - プレイヤー名を表示
    - ホストマークを表示
    - リアルタイム更新
    - _要件: 10.2_
  - [x] 9.3 接続状態インジケーターを実装
    - 接続中、接続済み、切断のアイコン
    - 色で視覚的に表示
    - _要件: 10.3_
  - [x] 9.4 トーストメッセージを実装
    - エラーメッセージ表示
    - 成功メッセージ表示
    - 自動消去 (3秒)
    - _要件: 10.4_
  - [x] 9.5 ローディングスピナーを実装
    - API呼び出し中に表示
    - 半透明オーバーレイ
    - _要件: 10.5_

- [x] 10. パフォーマンス最適化

  - [x] 10.1 データ圧縮を実装
    - 位置、速度、回転をFloat32に変換
    - 差分のみ送信
    - _要件: 8.4_
  - [x] 10.2 ネットワーク最適化を実装
    - バッチ処理
    - 変化がない場合はスキップ
    - _要件: 8.4_
  - [x] 10.3 Redis最適化を実装
    - パイプライン処理
    - インデックス最適化
    - _要件: 8.5_
  - [ ]\* 10.4 パフォーマンステストを作成
    - 20人同時プレイのテスト
    - レスポンスタイムのテスト
    - FPSのテスト
    - _要件: 8.1, 8.2_

- [x] 11. 統合とテスト

  - [x] 11.1 クライアント-サーバー統合
    - 全コンポーネントを統合
    - エンドツーエンドのフローを確認
    - _要件: 全体_
  - [x] 11.2 マルチプレイヤーテスト
    - 複数ブラウザでテスト
    - 同期の確認
    - エラーハンドリングの確認
    - _要件: 4.1, 4.4, 7.1_
  - [ ]\* 11.3 E2Eテストを作成
    - ゲーム作成から終了までのテスト
    - 複数プレイヤーの同期テスト
    - エラーハンドリングのテスト
    - _要件: 全体_

- [x] 12. ドキュメントとデプロイ
  - [x] 12.1 READMEを更新
    - マルチプレイヤー機能の説明を追加
    - セットアップ手順を更新
    - _要件: なし (ドキュメント)_
  - [x] 12.2 デプロイとテスト
    - make deployでデプロイ
    - Devvitでプレイテスト
    - 複数アカウントでテスト
    - _要件: 全体_

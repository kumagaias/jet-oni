# マルチプレイヤー機能 要件ドキュメント

## 概要

JET ONIゲームにリアルタイムマルチプレイヤー機能を実装する。複数のプレイヤーが同じゲームセッションに参加し、リアルタイムで対戦できるようにする。

## 用語集

- **Game Session**: ゲームセッション。複数のプレイヤーが参加するゲームインスタンス
- **Host**: ホスト。ゲームを作成したプレイヤー
- **Client**: クライアント。ゲームに参加したプレイヤー
- **Game State**: ゲーム状態。全プレイヤーの位置、速度、燃料などの情報
- **Sync**: 同期。クライアント間でゲーム状態を共有すること
- **Lobby**: ロビー。ゲーム開始前の待機画面
- **Redis**: データストア。ゲームセッション情報を保存

## 要件

### 要件1: ゲーム作成

**ユーザーストーリー**: ホストとして、新しいゲームセッションを作成したい

#### 受入基準

1. WHEN ユーザーが「Create Game」ボタンをクリックする, THE システム SHALL ゲーム設定画面を表示する
2. WHEN ユーザーがプレイヤー数を選択する, THE システム SHALL 4, 6, 8, 10, 15, 20人から選択可能にする
3. WHEN ユーザーがゲーム時間を選択する, THE システム SHALL 3分または5分から選択可能にする
4. WHEN ユーザーが「Start」ボタンをクリックする, THE システム SHALL `/api/game/create` APIを呼び出す
5. WHEN API呼び出しが成功する, THE システム SHALL ゲームIDを受け取りロビー画面に遷移する

### 要件2: ゲーム参加

**ユーザーストーリー**: プレイヤーとして、既存のゲームセッションに参加したい

#### 受入基準

1. WHEN ユーザーが「Join Game」ボタンをクリックする, THE システム SHALL `/api/game/list` APIを呼び出す
2. WHEN ゲームリストを取得する, THE システム SHALL 参加可能なゲームのリストを表示する
3. WHEN ユーザーがゲームを選択する, THE システム SHALL `/api/game/join` APIを呼び出す
4. WHEN 参加が成功する, THE システム SHALL ロビー画面に遷移する
5. IF ゲームが満員である, THEN THE システム SHALL エラーメッセージを表示する

### 要件3: ロビー機能

**ユーザーストーリー**: プレイヤーとして、ロビーで他のプレイヤーを待ちたい

#### 受入基準

1. WHEN ロビー画面を表示する, THE システム SHALL 現在のプレイヤー数を表示する
2. WHEN 新しいプレイヤーが参加する, THE システム SHALL プレイヤー数を更新する
3. WHEN 最大人数に達する, THE システム SHALL 3秒カウントダウンを開始する
4. WHEN カウントダウンが終了する, THE システム SHALL ゲームを自動開始する
5. WHEN ホストがSPACEキーを押す, THE システム SHALL 早期にゲームを開始する

### 要件4: リアルタイム同期（Devvit Realtime使用）

**ユーザーストーリー**: プレイヤーとして、他のプレイヤーの動きをリアルタイムで見たい

#### 受入基準

1. WHEN ゲームが開始する, THE システム SHALL Devvit Realtimeチャンネルに接続する
2. WHEN プレイヤーが移動する, THE システム SHALL Realtimeチャンネルに状態を送信する
3. WHEN 他のプレイヤーが状態を送信する, THE システム SHALL onMessageハンドラで受信する
4. WHEN 状態を受信する, THE システム SHALL 画面上の位置を即座に更新する
5. WHEN ネットワークが切断される, THE システム SHALL onDisconnectハンドラで再接続を試みる

### 要件5: プレイヤー状態管理

**ユーザーストーリー**: システムとして、全プレイヤーの状態を正確に管理したい

#### 受入基準

1. WHEN プレイヤーが移動する, THE システム SHALL 位置、速度、回転を記録する
2. WHEN プレイヤーが能力を使用する, THE システム SHALL 燃料、ダッシュ、ジェットパック状態を記録する
3. WHEN プレイヤーが鬼になる, THE システム SHALL isOniフラグを更新する
4. WHEN プレイヤーがタグ付けされる, THE システム SHALL 生存時間を記録する
5. WHEN プレイヤーが切断する, THE システム SHALL ゲームセッションから削除する

### 要件6: ゲーム終了

**ユーザーストーリー**: プレイヤーとして、ゲーム終了時に結果を見たい

#### 受入基準

1. WHEN タイマーが0になる, THE システム SHALL ゲームを終了する
2. WHEN 全プレイヤーが鬼になる, THE システム SHALL ゲームを終了する
3. WHEN ゲームが終了する, THE システム SHALL `/api/game/end` APIを呼び出す
4. WHEN 結果を計算する, THE システム SHALL 生存時間順にプレイヤーをソートする
5. WHEN 結果画面を表示する, THE システム SHALL 各プレイヤーの順位と生存時間を表示する

### 要件7: エラーハンドリング

**ユーザーストーリー**: プレイヤーとして、エラーが発生しても適切に対処したい

#### 受入基準

1. IF ネットワークエラーが発生する, THEN THE システム SHALL エラーメッセージを表示する
2. IF サーバーが応答しない, THEN THE システム SHALL 3回リトライする
3. IF ゲームセッションが見つからない, THEN THE システム SHALL タイトル画面に戻る
4. IF プレイヤーが切断する, THEN THE システム SHALL AIプレイヤーに置き換える
5. WHEN エラーから回復する, THE システム SHALL 同期を再開する

### 要件8: パフォーマンス

**ユーザーストーリー**: プレイヤーとして、スムーズなゲームプレイを体験したい

#### 受入基準

1. WHEN Realtimeで状態を同期する, THE システム SHALL ほぼゼロレイテンシで配信する
2. WHEN プレイヤー数が20人である, THE システム SHALL 60FPSを維持する
3. WHEN ネットワーク遅延が発生する, THE システム SHALL 補間で滑らかに表示する
4. WHEN データを送信する, THE システム SHALL 必要最小限のデータのみ送信する
5. WHEN Realtimeメッセージを送信する, THE システム SHALL イベント駆動で効率的に配信する

### 要件9: セキュリティ

**ユーザーストーリー**: システムとして、不正な操作を防ぎたい

#### 受入基準

1. WHEN クライアントが状態を送信する, THE システム SHALL サーバー側で検証する
2. WHEN 移動速度が異常である, THE システム SHALL 補正する
3. WHEN 不正なゲームIDを受信する, THE システム SHALL エラーを返す
4. WHEN APIリクエストを受信する, THE システム SHALL レート制限を適用する
5. WHEN ユーザー認証を確認する, THE システム SHALL Redditユーザー情報を検証する

### 要件10: UI/UX

**ユーザーストーリー**: プレイヤーとして、直感的なUIでゲームを楽しみたい

#### 受入基準

1. WHEN ゲームリストを表示する, THE システム SHALL ゲーム情報を見やすく表示する
2. WHEN ロビーで待機する, THE システム SHALL プレイヤーリストを表示する
3. WHEN 接続状態を表示する, THE システム SHALL アイコンで視覚的に示す
4. WHEN エラーが発生する, THE システム SHALL トーストメッセージで通知する
5. WHEN ローディング中である, THE システム SHALL スピナーを表示する

### 要件11: Realtime接続管理

**ユーザーストーリー**: システムとして、Realtime接続を適切に管理したい

#### 受入基準

1. WHEN ゲームが開始する, THE システム SHALL ゲーム固有のRealtimeチャンネルに接続する
2. WHEN 接続が確立される, THE システム SHALL onConnectハンドラで初期化処理を実行する
3. WHEN 接続が切断される, THE システム SHALL onDisconnectハンドラで再接続を試みる
4. WHEN ゲームが終了する, THE システム SHALL Realtime接続を切断する
5. WHEN 複数のゲームセッションが存在する, THE システム SHALL チャンネル名でゲームを識別する

# 実装計画

- [x] 1. プロジェクト構造とコア設定のセットアップ

  - プロジェクトのフォルダ構造を作成（src/client、src/server、src/shared）
  - TypeScript設定ファイルを作成（tsconfig.json、各フォルダ用）
  - Vite設定ファイルを作成（クライアント・サーバー用）
  - package.jsonにスクリプトとdevvit.jsonを設定
  - Makefileを作成（test、deploy、deploy-quick、prターゲット）
  - _要件: 1.1, 1.2, 1.3_
  - **手動確認**:
    - [x] `make test` が実行できることを確認
    - [x] `make build` が実行できることを確認
    - [x] `make pr` が実行できることを確認（GitHub CLI認証済みの場合）
    - [x] フォルダ構造が正しいことを確認

- [x] 2. 共有型定義と定数の実装

  - src/shared/types/game.tsにゲーム状態の型を定義
  - src/shared/types/api.tsにAPIの型を定義
  - src/shared/constants.tsにゲーム定数を定義（速度、燃料消費率など）
  - _要件: 3.1, 3.2, 4.2, 4.3, 5.2, 5.3_

- [x] 3. 多言語対応システムの実装

  - [x] 3.1 i18nクラスとシステムを実装
    - src/client/i18n/i18n.tsにI18nクラスを作成
    - 翻訳取得、言語切り替え、UI更新機能を実装
    - _要件: 13.1, 13.2, 13.3, 13.4_
  - [x] 3.2 翻訳ファイルを作成
    - src/client/i18n/translations/en.tsに英語翻訳を作成
    - src/client/i18n/translations/jp.tsに日本語翻訳を作成
    - メニュー、ゲーム、コントロール、結果の全テキストを含める
    - _要件: 13.5_
  - [x] 3.3 i18nシステムのテストを作成
    - 翻訳取得のテスト
    - 言語切り替えのテスト
    - パラメータ置換のテスト
    - _要件: 13.1, 13.2_

- [x] 4. Three.jsシーンとゲームエンジンの初期化

  - [x] 4.1 基本的なThree.jsシーンをセットアップ
    - src/client/game/game-engine.tsを作成
    - シーン、カメラ、レンダラーを初期化
    - ライティングとフォグを設定
    - ゲームループを実装
    - _要件: 3.5, 15.1_
  - [x] 4.2 ゲーム状態管理を実装
    - src/client/game/game-state.tsを作成
    - ローカルゲーム状態（位置、速度、燃料、鬼フラグ）を管理
    - ゲームフェーズ（ロビー、プレイ中、終了）を管理
    - _要件: 2.4, 2.5, 7.2_
  - [x] 4.3 ゲームエンジンのテストを作成
    - シーン初期化のテスト
    - ゲームループのテスト
    - _要件: 3.5_

- [x] 5. 都市環境の生成

  - [x] 5.1 都市生成システムを実装
    - src/client/environment/city-generator.tsを作成
    - 建物、家、道路、川、橋を生成
    - 占有エリアの追跡で重複を防止
    - ランドマークタワーを生成
    - _要件: 12.1, 12.2, 12.3, 12.4_
  - [x] 5.2 動的オブジェクトを実装
    - src/client/environment/dynamic-objects.tsを作成
    - 車の移動ロジック
    - 歩行者のアニメーション
    - はしごシステム
    - _要件: 12.3, 12.7_
  - [x] 5.3 都市生成のテストを作成
    - 建物数の検証
    - 衝突のない配置の検証
    - _要件: 12.1, 12.2_

- [x] 6. プレイヤー物理演算と衝突判定

  - [x] 6.1 物理演算システムを実装
    - src/client/player/player-physics.tsを作成
    - 重力、速度、加速度を実装
    - 地面・屋上・橋の着地判定
    - 水中判定と速度減少
    - _要件: 3.6, 3.7, 12.6_
  - [x] 6.2 衝突判定システムを実装
    - src/client/environment/collision-system.tsを作成
    - 建物との衝突判定（ボックス・シリンダー）
    - 車・歩行者との衝突判定
    - 衝突時のスライディング
    - _要件: 3.6, 12.5_
  - [x] 6.3 物理演算と衝突のテストを作成
    - 衝突判定アルゴリズムのテスト
    - 屋上着地のテスト
    - _要件: 3.6, 3.7_

- [x] 7. プレイヤーコントローラーと移動

  - [x] 7.1 入力処理を実装
    - src/client/player/player-controller.tsを作成
    - キーボード入力（WASD、SPACE、SHIFT）を処理
    - マウス入力（ルック）を処理
    - ポインターロックを管理
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_
    - **手動確認**:
      - [ ] `npm run dev` でブラウザを開く
      - [ ] 画面をクリックしてポインターロックを有効化
      - [ ] Wキーで前進することを確認
      - [ ] Sキーで後退することを確認
      - [ ] Aキーで左移動することを確認
      - [ ] Dキーで右移動することを確認
      - [ ] マウス移動でカメラが回転することを確認
      - [ ] ESCキーでポインターロックが解除されることを確認
  - [x] 7.2 移動ロジックを実装
    - 前後左右の移動
    - 速度の補間とスムージング
    - 鬼の速度ブースト（1.5倍）
    - マップ境界の制限
    - _要件: 3.1, 3.2, 3.3, 3.4_
    - **手動確認**:
      - [ ] 移動がスムーズであることを確認
      - [ ] 急停止せず、徐々に減速することを確認
      - [ ] マップ境界で停止することを確認
      - [ ] 鬼モード時に移動速度が速いことを確認
  - [x] 7.3 プレイヤーコントローラーのテストを作成
    - 入力処理のテスト
    - 移動計算のテスト
    - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 8. ジェットパックとジャンプ機能

  - [ ] 8.1 ジェットパック機能を実装
    - 鬼用のジェットパック飛行（SPACE長押し）
    - 燃料消費（毎秒30ユニット）
    - 上向き速度の適用
    - _要件: 4.1, 4.2, 4.3_
  - [ ] 8.2 ジャンプ機能を実装
    - 逃げる側用のジャンプ（SPACE、表面上のみ）
    - 燃料消費なし
    - _要件: 4.4_
  - [ ] 8.3 燃料システムを実装
    - 燃料ゲージ（0-100）
    - 鬼の燃料回復（表面上で毎秒20ユニット）
    - 逃げる側の燃料回復（表面上で静止時に毎秒20ユニット）
    - 燃料ゼロ時の能力無効化
    - _要件: 4.5, 4.6, 4.7_
  - [ ] 8.4 ジェットパックとジャンプのテストを作成
    - 燃料消費のテスト
    - 燃料回復のテスト
    - _要件: 4.2, 4.5, 4.6_

- [ ] 9. ダッシュ能力

  - [ ] 9.1 ダッシュ機能を実装
    - 逃げる側専用（SHIFT長押し）
    - 速度を20ユニット/秒に増加
    - 燃料消費（毎秒25ユニット）
    - 燃料ゼロ時の無効化
    - _要件: 5.1, 5.2, 5.3, 5.4_
  - [ ] 9.2 鬼のダッシュ制限を実装
    - 鬼はダッシュ不可
    - _要件: 5.5_
  - [ ] 9.3 ダッシュ機能のテストを作成
    - ダッシュ速度のテスト
    - 燃料消費のテスト
    - 鬼の制限のテスト
    - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 10. ビーコン能力

  - [ ] 10.1 ビーコンシステムを実装
    - 鬼専用の能力
    - 30秒のリチャージタイマー
    - 起動時に全逃げる側の位置を10秒間表示
    - リチャージ進行状況の表示
    - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_
  - [ ] 10.2 ビーコンビジュアルを実装
    - 逃げる側の上に黄色のビーム
    - グローエフェクト
    - パルスアニメーション
    - _要件: 6.2, 11.6_
  - [ ] 10.3 ビーコン機能のテストを作成
    - リチャージタイマーのテスト
    - 表示時間のテスト
    - _要件: 6.1, 6.3, 6.4, 6.5_

- [ ] 11. カメラシステム

  - [ ] 11.1 一人称カメラを実装
    - src/client/player/player-camera.tsを作成
    - プレイヤーの目の高さにカメラを配置
    - マウスルック（ヨー・ピッチ）
    - 垂直回転の制限
    - _要件: 15.1, 15.4, 15.5_
  - [ ] 11.2 三人称カメラを実装
    - はしご登り時のカメラ
    - プレイヤーの後ろに配置
    - プレイヤーを見る
    - _要件: 15.2_
  - [ ] 11.3 カメラスムージングを実装
    - 地上移動時の水平レベリング
    - スムーズな遷移
    - _要件: 15.3_
  - [ ] 11.4 カメラシステムのテストを作成
    - カメラ位置計算のテスト
    - 回転制限のテスト
    - _要件: 15.1, 15.2, 15.4_

- [ ] 12. 視覚的インジケーターとエフェクト

  - [ ] 12.1 プレイヤーマーカーを実装
    - src/client/effects/visual-indicators.tsを作成
    - プレイヤーの上にコーン型マーカー
    - 鬼は赤、逃げる側は緑
    - 移動時90%、静止時50%の不透明度
    - 回転アニメーション
    - _要件: 11.1, 11.2, 11.3, 11.4_
  - [ ] 12.2 パーティクルエフェクトを実装
    - src/client/effects/particle-system.tsを作成
    - ジェットパックの炎パーティクル
    - ダッシュのトレイルパーティクル
    - オブジェクトプールで最適化
    - _要件: 4.1, 5.1_
  - [ ] 12.3 スポットインジケーターを実装
    - 逃げる側が鬼に見つかった時の表示
    - 「見つかった！」メッセージ
    - パルスアニメーション
    - _要件: 11.5_
  - [ ] 12.4 ビジュアルエフェクトのテストを作成
    - マーカー色のテスト
    - 不透明度のテスト
    - _要件: 11.1, 11.2, 11.3, 11.4_

- [ ] 13. AIプレイヤーシステム

  - [ ] 13.1 AI意思決定を実装
    - src/client/ai/ai-controller.tsを作成
    - ターゲット選択ロジック
    - 行動の切り替え（追跡・逃走・徘徊）
    - 能力使用の判断
    - _要件: 8.1, 8.2, 8.3_
  - [ ] 13.2 AI行動を実装
    - src/client/ai/ai-behavior.tsを作成
    - 追跡行動（最も近い逃げる側を追う）
    - 逃走行動（近くの鬼から逃げる）
    - 徘徊行動（ランダム移動）
    - _要件: 8.1, 8.2, 8.3_
  - [ ] 13.3 AI能力使用を実装
    - ジェットパックの定期的使用
    - ダッシュの定期的使用
    - クールダウンタイマー
    - _要件: 8.4, 8.5_
  - [ ] 13.4 AIシステムのテストを作成
    - ターゲット選択のテスト
    - 行動切り替えのテスト
    - _要件: 8.1, 8.2, 8.3_

- [ ] 14. タグ付けメカニクス

  - [ ] 14.1 タグ付け判定を実装
    - 鬼と逃げる側の距離チェック（1.5ユニット以内）
    - タグ付け時の状態変更
    - 生存時間の記録
    - _要件: 7.1, 7.2, 7.3_
  - [ ] 14.2 タグ付け通知を実装
    - トーストメッセージの表示
    - 「鬼になった！」「タグ付けした！」メッセージ
    - アニメーション
    - _要件: 7.4_
  - [ ] 14.3 鬼変換処理を実装
    - プレイヤーの色変更（緑→赤）
    - ビーコンリチャージの開始
    - 能力の切り替え（ダッシュ→ジェットパック）
    - _要件: 7.2, 7.5_
  - [ ] 14.4 タグ付けメカニクスのテストを作成
    - 距離判定のテスト
    - 状態変更のテスト
    - _要件: 7.1, 7.2, 7.3_

- [ ] 15. ゲームタイマーと終了条件

  - [ ] 15.1 タイマーシステムを実装
    - カウントダウンタイマー
    - 残り時間の表示
    - 60秒未満で警告色、30秒未満で危険色
    - _要件: 9.1, 9.2, 9.3, 9.4_
  - [ ] 15.2 ゲーム終了判定を実装
    - タイマーゼロでゲーム終了
    - 全プレイヤーが鬼でゲーム終了
    - ゲーム終了フラグの設定
    - _要件: 9.5, 9.6_
  - [ ] 15.3 ゲーム終了処理を実装
    - 結果画面への遷移
    - 統計の更新
    - _要件: 9.7_
  - [ ] 15.4 タイマーと終了条件のテストを作成
    - タイマーカウントダウンのテスト
    - 終了条件のテスト
    - _要件: 9.1, 9.5, 9.6_

- [ ] 16. UIシステム - メニューとロビー

  - [x] 16.1 タイトル画面を実装
    - src/client/ui/ui-menu.tsを作成
    - 言語選択ボタン
    - 「ゲーム作成」「ゲーム参加」ボタン
    - 統計表示ボタン
    - _要件: 1.1, 1.2, 1.7_
    - **手動確認**:
      - [ ] タイトル画面が表示されることを確認
      - [ ] ENボタンで英語に切り替わることを確認
      - [ ] JPボタンで日本語に切り替わることを確認
      - [ ] 言語設定がlocalStorageに保存されることを確認
      - [ ] ページをリロードしても言語設定が保持されることを確認
      - [ ] 各ボタンがクリック可能であることを確認
  - [ ] 16.2 ゲーム設定画面を実装
    - プレイヤー数選択（4, 6, 8, 10, 15, 20）
    - 時間選択（3分、5分）
    - ラウンド数選択（1, 3, 5）
    - 設定確定ボタン
    - _要件: 1.3, 1.4, 1.5, 1.6_
    - **手動確認**:
      - [ ] 「ゲーム作成」ボタンで設定画面が表示されることを確認
      - [ ] 各設定オプションが選択可能であることを確認
      - [ ] 選択したオプションがハイライトされることを確認
      - [ ] 「戻る」ボタンでタイトル画面に戻ることを確認
      - [ ] 「ゲーム開始」ボタンでロビーに移動することを確認
  - [ ] 16.3 ゲームリスト画面を実装
    - 利用可能なゲームのリスト表示
    - 各ゲームの情報（プレイヤー数、時間、ラウンド）
    - 参加ボタン
    - _要件: 1.7, 1.8_
    - **手動確認**:
      - [ ] 「ゲーム参加」ボタンでゲームリストが表示されることを確認
      - [ ] ゲーム情報が正しく表示されることを確認
      - [ ] 満員のゲームの参加ボタンが無効化されることを確認
      - [ ] 「戻る」ボタンでタイトル画面に戻ることを確認
  - [ ] 16.4 ロビー画面を実装
    - 現在のプレイヤー数表示
    - 「SPACEで開始」メッセージ（ホストのみ）
    - AIプレイヤーの自動追加
    - _要件: 2.1, 2.2, 2.3_
    - **手動確認**:
      - [ ] ロビー画面が表示されることを確認
      - [ ] プレイヤー数が正しく表示されることを確認
      - [ ] AIプレイヤーが自動的に追加されることを確認
      - [ ] SPACEキーでゲームが開始することを確認
      - [ ] ゲーム開始時にロビー画面が非表示になることを確認
  - [ ] 16.5 メニューUIのテストを作成
    - 画面遷移のテスト
    - 設定保存のテスト
    - _要件: 1.1, 1.2, 1.3_

- [ ] 17. UIシステム - HUDとゲーム内表示

  - [ ] 17.1 HUDを実装
    - src/client/ui/ui-hud.tsを作成
    - タイマー表示
    - プレイヤーカウント（鬼・逃げる側）
    - 燃料ゲージ
    - ステータス表示（鬼/逃げる側）
    - _要件: 9.2, 9.3, 9.4_
  - [ ] 17.2 デバッグ情報を実装
    - F3キーでデバッグモード切り替え
    - 位置、速度の表示
    - 鬼情報、AIプレイヤー情報
    - _要件: なし（開発用）_
  - [ ] 17.3 HUDのテストを作成
    - タイマー表示のテスト
    - プレイヤーカウントのテスト
    - _要件: 9.2_

- [ ] 18. UIシステム - 結果と統計

  - [ ] 18.1 結果画面を実装
    - src/client/ui/ui-results.tsを作成
    - プレイヤーリスト（生存時間順）
    - 最長生存者のハイライト
    - 逃げ切り/タグ付けの表示
    - メニューに戻るボタン
    - _要件: 10.1, 10.2, 10.3_
  - [ ] 18.2 統計システムを実装
    - localStorageへの統計保存
    - 総ゲーム数、勝利数、敗北数
    - 勝率計算
    - 統計リセット機能
    - _要件: 10.4, 10.5, 10.6, 10.7, 10.8_
  - [ ] 18.3 統計表示画面を実装
    - 統計の表示
    - リセットボタン
    - _要件: 10.5, 10.6, 10.7, 10.8_
  - [ ] 18.4 結果と統計のテストを作成
    - 統計計算のテスト
    - localStorage保存のテスト
    - _要件: 10.4, 10.5, 10.6, 10.7, 10.8_

- [ ] 19. モバイルコントロール

  - [ ] 19.1 タッチボタンを実装
    - src/client/ui/ui-controls.tsを作成
    - ダッシュ/ジェットパックボタン
    - ビーコンボタン（鬼のみ）
    - タッチイベント処理
    - _要件: 14.1, 14.2, 14.3, 14.4_
  - [ ] 19.2 ボタンの視覚的フィードバックを実装
    - 押下時のスケールアニメーション
    - 無効時のグレーアウト
    - 鬼モード時の色変更
    - _要件: 14.5_
  - [ ] 19.3 モバイルコントロールのテストを作成
    - タッチイベント処理のテスト
    - ボタン状態のテスト
    - _要件: 14.1, 14.2, 14.3, 14.4_

- [ ] 20. サーバーAPI - ゲーム管理

  - [ ] 20.1 ゲームAPIエンドポイントを実装
    - src/server/api/game-api.tsを作成
    - POST /api/game/create - ゲーム作成
    - POST /api/game/join - ゲーム参加
    - GET /api/game/:id - ゲーム状態取得
    - POST /api/game/:id/end - ゲーム終了
    - _要件: 1.6, 1.8_
  - [ ] 20.2 ゲームマネージャーを実装
    - src/server/core/game-manager.tsを作成
    - ゲームセッションの作成・管理
    - プレイヤーの追加・削除
    - 鬼のランダム割り当て
    - _要件: 2.4, 2.5_
  - [ ] 20.3 ゲームAPIのテストを作成
    - エンドポイントのテスト
    - ゲーム作成・参加のテスト
    - _要件: 1.6, 1.8_

- [ ] 21. サーバーAPI - 統計管理

  - [ ] 21.1 統計APIエンドポイントを実装
    - src/server/api/stats-api.tsを作成
    - POST /api/stats - 統計保存
    - GET /api/stats/:userId - 統計取得
    - _要件: 10.4_
  - [ ] 21.2 Redisストレージを実装
    - src/server/core/redis-storage.tsを作成
    - ゲーム状態の保存・取得
    - 統計の保存・取得
    - TTL設定
    - _要件: 10.4_
  - [ ]\* 21.3 統計APIのテストを作成
    - エンドポイントのテスト
    - Redis操作のモック
    - _要件: 10.4_

- [ ] 22. 統合とポリッシュ

  - [x] 22.1 クライアント-サーバー統合
    - APIクライアントの実装
    - エラーハンドリング
    - リトライロジック
    - _要件: 全体_
  - [ ] 22.2 パフォーマンス最適化
    - レンダリング最適化
    - 物理演算最適化
    - メモリ管理
    - _要件: 全体_
  - [ ] 22.3 バグ修正とポリッシュ
    - エッジケースの処理
    - UIの微調整
    - アニメーションのスムージング
    - _要件: 全体_
  - [ ] 22.4 統合テストを作成
    - エンドツーエンドのゲームフロー
    - クライアント-サーバー通信
    - _要件: 全体_

- [ ] 23. セキュリティとCI/CDのセットアップ

  - [ ] 23.1 GitHub Actionsワークフローを作成
    - .github/workflows/codeql.ymlを作成（CodeQLセキュリティスキャン）
    - .github/workflows/dependency-check.ymlを作成（依存関係チェック）
    - .github/workflows/secret-scan.ymlを作成（シークレットスキャン）
    - .github/workflows/ci.ymlを作成（CI/CDパイプライン）
    - _要件: なし（セキュリティ）_
    - **手動確認**:
      - [ ] .github/workflowsフォルダが存在することを確認
      - [ ] 4つのワークフローファイルが存在することを確認
      - [ ] YAMLファイルの構文が正しいことを確認
      - [ ] GitHubにプッシュ後、Actionsタブでワークフローが実行されることを確認
  - [ ] 23.2 GitHubリポジトリのセキュリティ設定
    - GitHub Secretsを設定（DEVVIT_TOKEN）
    - Dependabotを有効化
    - CodeQLを有効化
    - ブランチ保護ルールを設定
    - _要件: なし（セキュリティ）_
    - **手動確認**:
      - [ ] Settings → Secrets and variables → Actionsで DEVVIT_TOKEN が設定されていることを確認
      - [ ] Settings → Security → Dependabotが有効化されていることを確認
      - [ ] Settings → Security → Code scanningでCodeQLが有効化されていることを確認
      - [ ] Settings → Branches でmainブランチの保護ルールが設定されていることを確認
      - [ ] 保護ルールに「Require status checks to pass」が含まれることを確認

- [ ] 24. ドキュメントとデプロイ
  - [ ] 24.1 READMEを作成
    - プロジェクト概要
    - セットアップ手順
    - 開発ガイド
    - デプロイ手順
    - _要件: なし（ドキュメント）_
    - **手動確認**:
      - [ ] README.mdが存在することを確認
      - [ ] セットアップ手順が明確であることを確認
      - [ ] 全てのコマンドが正しいことを確認
  - [ ] 24.2 デプロイ設定を確認
    - Makefileの動作確認
    - devvit.jsonの設定確認
    - ビルドプロセスの検証
    - _要件: なし（デプロイ）_
    - **手動確認**:
      - [ ] `make test` が成功することを確認
      - [ ] `make build` が成功することを確認
      - [ ] `npm run build` が成功することを確認
      - [ ] `dist/client/` にクライアントファイルが生成されることを確認
      - [ ] `dist/server/` にサーバーファイルが生成されることを確認
      - [ ] devvit.jsonの設定が正しいことを確認
  - [ ] 24.3 最終テストとデプロイ
    - 全テストの実行
    - make deployでデプロイ
    - Devvitでのプレイテスト
    - _要件: 全体_
    - **手動確認**:
      - [ ] `make test` で全テストが成功することを確認
      - [ ] `npm run build` でビルドが成功することを確認
      - [ ] `make deploy` でデプロイが成功することを確認
      - [ ] Devvitのプレイテストでゲームが起動することを確認
      - [ ] タイトル画面が表示されることを確認
      - [ ] ゲームが正常にプレイできることを確認
      - [ ] 全ての機能が動作することを確認
      - [ ] モバイルでも動作することを確認（可能であれば）

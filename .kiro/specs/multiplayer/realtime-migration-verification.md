# Realtime移行パフォーマンス検証ガイド

## 概要

このドキュメントは、HTTPポーリングからDevvit Realtimeへの移行後のパフォーマンス検証手順を記載しています。

## 検証項目

### 1. リクエスト数の削減確認 (80%削減目標)

#### HTTPポーリング時代（移行前）
- 送信ループ: 500ms間隔 = 2回/秒
- 受信ループ: 500ms間隔 = 2回/秒
- 合計: 4回/秒/プレイヤー
- 10プレイヤーの場合: 40回/秒

#### Realtime移行後
- イベント駆動: 状態変更時のみ送信
- スロットリング: 最大60回/秒（実際は変更時のみ）
- 予想: 平均1回/秒/プレイヤー（75%削減）

#### 検証方法

1. **開発者ツールでネットワークタブを開く**
   - Chrome DevTools → Network タブ
   - Filter: `api/game` または `realtime`

2. **HTTPポーリング時のリクエスト数を記録**（参考値）
   - 1分間のリクエスト数をカウント
   - プレイヤー数で割って平均を算出

3. **Realtime移行後のメッセージ数を記録**
   - Console で `realtimeSyncManager.getNetworkStats()` を実行
   - 1分間のメッセージ送信数をカウント

4. **削減率を計算**
   ```
   削減率 = (移行前 - 移行後) / 移行前 × 100%
   目標: 80%削減
   ```

### 2. レイテンシの改善確認 (ほぼゼロ目標)

#### HTTPポーリング時代
- 平均レイテンシ: 500ms（ポーリング間隔）
- 最大レイテンシ: 1000ms

#### Realtime移行後
- 平均レイテンシ: <50ms（ほぼゼロ）
- 最大レイテンシ: <100ms

#### 検証方法

1. **タイムスタンプを記録**
   - RealtimeMessage に timestamp フィールドを追加済み
   - 受信時に `Date.now() - message.timestamp` でレイテンシを計算

2. **Console でレイテンシを確認**
   ```javascript
   // main.ts の handleMessage 内で以下を追加
   const latency = Date.now() - data.timestamp;
   console.log(`Realtime latency: ${latency}ms`);
   ```

3. **平均レイテンシを計算**
   - 1分間のレイテンシを記録
   - 平均値を算出
   - 目標: <50ms

### 3. 複数プレイヤーでの動作確認

#### 検証シナリオ

1. **2プレイヤーテスト**
   - 2つのブラウザウィンドウで同じゲームに参加
   - 一方のプレイヤーを移動
   - もう一方の画面で即座に反映されることを確認

2. **4プレイヤーテスト**
   - 4つのブラウザウィンドウで同じゲームに参加
   - 各プレイヤーを移動
   - 全プレイヤーの位置が正しく同期されることを確認

3. **10プレイヤーテスト**（可能であれば）
   - 10人で同時プレイ
   - FPSが60を維持できることを確認
   - レイテンシが100ms以下であることを確認

#### 確認項目

- [ ] プレイヤーの位置が即座に同期される
- [ ] プレイヤーの回転が正しく同期される
- [ ] 鬼の状態が正しく同期される
- [ ] ダッシュ/ジェットパック状態が同期される
- [ ] FPSが60を維持できる
- [ ] レイテンシが100ms以下である
- [ ] 切断時に自動再接続される

### 4. 接続管理の確認

#### 検証項目

1. **自動再接続**
   - ネットワークを一時的に切断
   - 再接続されることを確認
   - 最大3回リトライされることを確認

2. **切断検出**
   - プレイヤーが切断した場合
   - 10秒後に切断として検出されることを確認
   - AIプレイヤーに置き換えられることを確認

3. **接続状態表示**
   - 接続中: 緑色のインジケーター
   - 切断中: 赤色のインジケーター
   - 再接続中: 黄色のインジケーター

## 検証結果の記録

### テスト環境
- 日時: ___________
- ブラウザ: ___________
- プレイヤー数: ___________

### リクエスト数
- HTTPポーリング時: _____ 回/秒
- Realtime移行後: _____ 回/秒
- 削減率: _____ %

### レイテンシ
- HTTPポーリング時: _____ ms
- Realtime移行後: _____ ms
- 改善率: _____ %

### FPS
- HTTPポーリング時: _____ FPS
- Realtime移行後: _____ FPS

### 動作確認
- [ ] 2プレイヤーテスト: 合格/不合格
- [ ] 4プレイヤーテスト: 合格/不合格
- [ ] 10プレイヤーテスト: 合格/不合格
- [ ] 自動再接続: 合格/不合格
- [ ] 切断検出: 合格/不合格

## トラブルシューティング

### Realtimeに接続できない

**症状**: `Failed to connect to Realtime` エラー

**原因**:
- Devvit Realtime が有効になっていない
- チャンネル名が正しくない
- ネットワークエラー

**解決方法**:
1. `devvit.json` で `realtime` パーミッションが有効か確認
2. チャンネル名が `game:{gameId}` 形式か確認
3. ネットワーク接続を確認

### メッセージが送信されない

**症状**: `sendPlayerState` を呼び出してもメッセージが送信されない

**原因**:
- 接続が確立されていない
- スロットリングで送信がスキップされている

**解決方法**:
1. `realtimeSyncManager.isConnected()` で接続状態を確認
2. `realtimeSyncManager.getNetworkStats()` でスロットリング状態を確認

### プレイヤーの位置が同期されない

**症状**: 他のプレイヤーの位置が更新されない

**原因**:
- メッセージが受信されていない
- 補間が正しく動作していない

**解決方法**:
1. Console で `Realtime latency` ログを確認
2. `updateInterpolation` が毎フレーム呼ばれているか確認
3. `onRemotePlayerUpdate` コールバックが登録されているか確認

## まとめ

Realtime移行により、以下の改善が期待されます：

- ✅ リクエスト数: 80%削減
- ✅ レイテンシ: ほぼゼロ（<50ms）
- ✅ FPS: 60FPS維持
- ✅ スケーラビリティ: 20人同時プレイ対応

検証が完了したら、このドキュメントに結果を記録してください。
